<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potassium UI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        :root {
            --bg-primary: #181818; --bg-secondary: #1a1a1a; --bg-tertiary: #2a2a2a;
            --bg-accent: #222; --bg-settings-hover: #252525;
            --btn-g1: #1f1f1f; --btn-g2: #1c1c1c; --btn-g3: #1b1b1b;
            --btn-hg1: #2a2a2a; --btn-hg2: #252525; --btn-hg3: #222;
            --toggle-bg: #3a3a3c; --toggle-on: #909090; --toggle-border: #505050; --toggle-on-border: #606060;
            --text-primary: #d0d0d0; --text-secondary: #888; --text-tertiary: #606060;
            --text-btn: #b0b0b0; --text-btn-h: #d4d4d4; --text-title: #ccc; --text-active-tab: #d0d0d0;
            --border-primary: #282828; --border-secondary: #1f1f1f; --border-accent: #303030;
            --theme-border: #333; --theme-border-active: #888888;
            --icon-primary: #777; --icon-hover: #a0a0a0; --icon-active: #fff;
            --icon-search: #7f7f7f; --icon-tab-close: #707070; --icon-tab-close-h: #bbb;
            --icon-add-tab: #707070; --icon-add-tab-h: #999;
            --icon-btn: #b0b0b0; --icon-btn-h: #e0e0e0;
            --accent: #a0a0a0; --accent-dim: #555555; --red: #b85555;
            --dd-bg: #1e1e1e; --dd-border: #2e2e2e; --dd-hover: #272727; --dd-text: #c8c8c8;
        }
        .light-theme {
            --bg-primary: #fff; --bg-secondary: #f0f0f0; --bg-tertiary: #e0e0e0;
            --bg-accent: #ddd; --bg-settings-hover: #e5e5e5;
            --btn-g1: #f0f0f0; --btn-g2: #e8e8e8; --btn-g3: #e0e0e0;
            --btn-hg1: #ddd; --btn-hg2: #d0d0d0; --btn-hg3: #c8c8c8;
            --toggle-bg: #d0d0d0; --toggle-on: #3a3a3a; --toggle-on-border: #222; --toggle-border: #bbb; --theme-border-active: #3a3a3a;
            --text-primary: #222; --text-secondary: #555; --text-tertiary: #666;
            --text-btn: #333; --text-btn-h: #000; --text-title: #333; --text-active-tab: #000;
            --border-primary: #ccc; --border-secondary: #dcdcdc; --border-accent: #b0b0b0;
            --theme-border: #ccc; --icon-primary: #555; --icon-hover: #222; --icon-active: #000;
            --icon-search: #555; --icon-tab-close: #666; --icon-tab-close-h: #000;
            --icon-add-tab: #666; --icon-add-tab-h: #333; --icon-btn: #333; --icon-btn-h: #000;
            --accent: #3a3a3a; --accent-dim: #222222; --red: #b04040;
            --dd-bg: #f5f5f5; --dd-border: #ccc; --dd-hover: #e0e0e0; --dd-text: #222;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; color: var(--text-primary); overflow: hidden; }
        #app-container { width: 100vw; height: 100vh; background: var(--bg-primary); display: flex; flex-direction: column; overflow: hidden; transition: background .3s; }

        /* ── TITLE BAR ── */
        #app-header { background: var(--bg-primary); -webkit-app-region: drag; }
        .title-bar { display: flex; align-items: center; justify-content: space-between; padding: 4px 10px; height: 30px; position: relative; }
        .title { font-size: 13px; font-weight: 500; color: var(--text-title); }
        .top-center-actions { display: flex; align-items: center; gap: 22px; position: absolute; left: 50%; transform: translateX(-50%); -webkit-app-region: no-drag; }
        .action-icon-wrapper { position: relative; padding-bottom: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .action-icon-wrapper svg { width: 20px; height: 20px; stroke: var(--icon-primary); stroke-width: 2; fill: none; transition: stroke .2s; display: block; }
        .action-icon-wrapper:hover svg { stroke: var(--icon-hover); }
        .action-icon-wrapper.palette-icon svg circle { fill: var(--icon-primary); stroke: none; transition: fill .2s; }
        .action-icon-wrapper.palette-icon svg path { stroke: var(--icon-primary); fill: none; }
        .action-icon-wrapper.palette-icon:hover svg circle { fill: var(--icon-hover); }
        .action-icon-wrapper.palette-icon:hover svg path { stroke: var(--icon-hover); }
        .action-icon-wrapper.wrench-icon svg { transform: scaleX(-1); }
        .action-icon-wrapper.active-section-indicator svg { stroke: var(--icon-active); }
        .action-icon-wrapper.active-section-indicator.palette-icon svg path { stroke: var(--icon-active); }
        .action-icon-wrapper.active-section-indicator.palette-icon svg circle { fill: var(--icon-active); }
        .action-icon-wrapper.palette-icon:not(.active-section-indicator) svg path { stroke: var(--icon-primary); }
        .action-icon-wrapper.palette-icon:not(.active-section-indicator) svg circle { fill: var(--icon-primary); }
        .action-icon-wrapper.palette-icon:not(.active-section-indicator):hover svg path { stroke: var(--icon-hover); }
        .action-icon-wrapper.palette-icon:not(.active-section-indicator):hover svg circle { fill: var(--icon-hover); }
        .action-icon-wrapper.active-section-indicator::after { content: ''; display: block; width: 100%; height: 3px; background: var(--icon-active); position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); border-radius: 1px; }
        .title-bar-window-controls { display: flex; align-items: center; -webkit-app-region: no-drag; margin-left: auto; }
        .title-bar-window-controls svg { width: 16px; height: 16px; stroke: var(--icon-primary); stroke-width: 1.5; fill: none; margin-left: 18px; cursor: pointer; transition: stroke .2s; }
        .title-bar-window-controls svg:hover { stroke: var(--icon-hover); }
        #wcbtn-close:hover { stroke: var(--red) !important; }

        /* ── TAB BAR ── */
        #tab-bar { background: var(--bg-primary); display: flex; align-items: center; padding: 0 4px 0 0; height: 34px; overflow: hidden; }
        #tabs-and-add { display: flex; align-items: flex-end; flex-grow: 1; height: 100%; overflow: hidden; }
        #tabs-container { display: flex; align-items: flex-end; overflow-x: auto; overflow-y: hidden; scrollbar-width: none; height: 100%; max-width: calc(100% - 30px); }
        #tabs-container::-webkit-scrollbar { display: none; }
        .tab { display: flex; align-items: center; padding: 8px 10px; margin-right: 1px; background: var(--bg-primary); color: var(--text-secondary); font-size: 12px; cursor: pointer; border: none; position: relative; bottom: -1px; max-width: 160px; white-space: nowrap; overflow: hidden; line-height: 1; flex-shrink: 0; }
        .tab.active { background: var(--bg-tertiary); color: var(--text-active-tab); z-index: 1; }
        .tab-icon { margin-right: 6px; width: 14px; height: 14px; fill: currentColor; stroke: none; opacity: 0.7; flex-shrink: 0; }
        .active .tab-icon { opacity: 1; }
        .tab-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tab-name-input { background: var(--bg-tertiary); color: var(--text-active-tab); border: 1px solid var(--border-accent); font-size: 12px; width: 90px; }
        .tab-close-btn { margin-left: 6px; color: var(--icon-tab-close); font-size: 16px; font-weight: 300; background: transparent !important; border: none; padding: 0 2px; cursor: pointer; line-height: 1; flex-shrink: 0; }
        .tab-close-btn:hover { color: var(--icon-tab-close-h); }
        #add-tab-btn { color: var(--icon-add-tab); font-size: 20px; padding: 0 8px; background: transparent !important; border: none; cursor: pointer; display: flex; align-items: center; height: 100%; margin-left: 2px; flex-shrink: 0; position: relative; bottom: -1px; }
        #add-tab-btn:hover { color: var(--icon-add-tab-h); }
        #tab-bar-search-container { display: flex; align-items: center; background-color: var(--bg-accent); border: none; border-radius: 4px; padding: 0 8px; margin-left: auto; height: 26px; width: 210px; flex-shrink: 0; }
        #tab-bar-search-container svg { width: 14px; height: 14px; stroke: var(--icon-search); stroke-width: 2; fill: none; margin-right: 6px; flex-shrink: 0; }
        #tab-bar-search-input { background: transparent; border: none; outline: none; color: var(--text-primary); font-size: 12px; flex-grow: 1; width: 100%; }
        #tab-bar-search-input::placeholder { color: var(--text-tertiary); }

        /* ── APP BODY ── */
        #app-body { flex-grow: 1; display: flex; overflow: hidden; position: relative; }
        #app-body.settings-active, #app-body.theme-active { border-top: none; }
        #editor-view { display: flex; width: 100%; height: 100%; }
        #main-editor { flex-grow: 1; display: flex; overflow: hidden; background: #1a1a1a; }
        #monaco-container { width: 100%; height: 100%; }
        #right-sidebar { width: 230px; flex-shrink: 0; background: #1d1d1d; border-left: 1px solid var(--border-secondary); height: 100%; box-sizing: border-box; }

        /* ── SETTINGS / THEME VIEWS ── */
        #settings-view, #theme-view { width: 100%; height: 100%; background: var(--bg-primary); padding: 22px 26px; display: none; overflow-y: auto; }
        .sec-title { font-size: 10.5px; font-weight: 700; letter-spacing: .09em; text-transform: uppercase; color: var(--text-tertiary); margin: 0 0 8px; }
        .sec-title:not(:first-child) { margin-top: 26px; }
        .sec-divider { height: 1px; background: var(--border-primary); margin-bottom: 10px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 7px; margin-bottom: 2px; transition: background .15s; }
        .setting-row:hover { background: var(--bg-settings-hover); }
        .setting-label { display: flex; flex-direction: column; gap: 2px; }
        .setting-label .lbl { font-size: 13.5px; font-weight: 500; color: var(--text-primary); }
        .setting-label .desc { font-size: 11.5px; color: var(--text-secondary); }

        /* Toggle */
        .toggle-switch { position: relative; display: inline-block; width: 36px; height: 20px; cursor: pointer; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: var(--toggle-bg); border: 1px solid var(--toggle-border); transition: .3s; border-radius: 20px; }
        .slider::before { content: ""; position: absolute; width: 14px; height: 14px; border-radius: 50%; background: #888; bottom: 2px; left: 2px; transition: transform .3s, background .3s; }
        input:checked + .slider { background: var(--toggle-on); border-color: var(--toggle-on-border); }
        input:checked + .slider::before { transform: translateX(16px); background: #fff; }

        /* ── Custom dropdowns (replaces native selects everywhere in settings) ── */
        .cdd-wrap { position: relative; display: inline-block; min-width: 190px; user-select: none; }
        .cdd-trigger {
            display: flex; align-items: center; justify-content: space-between; gap: 8px;
            background: linear-gradient(to bottom, var(--btn-g1), var(--btn-g3));
            color: var(--text-primary); border: 1px solid var(--border-accent);
            border-radius: 6px; padding: 6px 10px 6px 12px;
            font-size: 12px; font-family: inherit; cursor: pointer;
            transition: border-color .2s, background .15s; white-space: nowrap; width: 100%;
        }
        .cdd-trigger:hover { background: linear-gradient(to bottom, var(--btn-hg1), var(--btn-hg3)); border-color: var(--icon-primary); }
        .cdd-trigger.open { border-color: var(--accent-dim); border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .cdd-trigger-left { display: flex; align-items: center; gap: 7px; overflow: hidden; }
        .cdd-trigger-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cdd-trigger-dot { width: 7px; height: 7px; border-radius: 50%; background: #444; flex-shrink: 0; transition: background .3s; }
        .cdd-trigger-dot.on { background: var(--accent); box-shadow: none; }
        .cdd-caret { width: 10px; height: 10px; stroke: var(--icon-primary); stroke-width: 2.5; fill: none; flex-shrink: 0; transition: transform .2s; }
        .cdd-trigger.open .cdd-caret { transform: rotate(180deg); }
        .cdd-panel {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--dd-bg); border: 1px solid var(--dd-border);
            border-top: 1px solid var(--accent-dim);
            border-radius: 0 0 8px 8px;
            box-shadow: 0 10px 28px rgba(0,0,0,.55);
            z-index: 8000; display: none; flex-direction: column; overflow: hidden;
        }
        .cdd-panel.open { display: flex; animation: cdd-in .1s ease; }
        @keyframes cdd-in { from { opacity:0; transform:translateY(-3px); } to { opacity:1; transform:translateY(0); } }
        .cdd-section-lbl { font-size: 10px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--text-tertiary); padding: 9px 12px 3px; }
        .cdd-divider { height: 1px; background: var(--dd-border); margin: 3px 0; }
        .cdd-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; cursor: pointer; font-size: 12.5px; color: var(--dd-text);
            transition: background .1s;
        }
        .cdd-item:hover { background: var(--dd-hover); }
        .cdd-item.active { color: var(--accent); font-weight: 600; background: var(--bg-settings-hover); }
        .cdd-item.danger { color: var(--red); }
        .cdd-item-left { display: flex; align-items: center; gap: 8px; }
        .cdd-item-dot { width: 6px; height: 6px; border-radius: 50%; background: #444; flex-shrink: 0; transition: background .3s; }
        .cdd-item-dot.port-open { background: var(--accent); }
        .cdd-item-badge { font-size: 10px; color: var(--text-tertiary); background: rgba(255,255,255,.04); border-radius: 3px; padding: 1px 5px; white-space: nowrap; }
        .cdd-item-badge.is-connected { color: var(--accent); }
        .cdd-item-icon { width: 13px; height: 13px; stroke: currentColor; stroke-width: 2; fill: none; flex-shrink: 0; }

        /* Status pill */
        .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 11px; border-radius: 20px; font-size: 12px; font-weight: 500; background: var(--bg-tertiary); border: 1px solid var(--border-accent); color: var(--text-secondary); transition: all .3s; white-space: nowrap; }
        .status-pill .dot { width: 7px; height: 7px; border-radius: 50%; background: #555; flex-shrink: 0; transition: all .3s; }
        .status-pill.connected { color: var(--accent); border-color: var(--accent-dim); }
        .status-pill.connected .dot { background: var(--accent); box-shadow: none; }

        /* sbtn kept for potential future use */

        /* Theme */
        .theme-options { display: flex; flex-direction: column; gap: 10px; }
        .theme-opt { display: flex; align-items: center; padding: 12px; border: 2px solid var(--theme-border); border-radius: 8px; cursor: pointer; transition: border-color .3s, box-shadow .3s; background: #1a1a1a; }
        .theme-opt:hover, .theme-opt.active-theme { border-color: var(--theme-border-active); }
        .theme-opt.active-theme { box-shadow: 0 0 10px rgba(160,160,160,.12); }
        .theme-preview { width: 80px; height: 50px; border-radius: 4px; margin-right: 14px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border-primary); }
        .tp-dark .ph { background: #333; height: 15px; } .tp-dark .pb { background: #444; flex-grow: 1; }
        .tp-light .ph { background: #eee; height: 15px; } .tp-light .pb { background: #fff; flex-grow: 1; }
        .theme-lbl { font-size: 14px; font-weight: 500; color: var(--text-primary); }

        /* ── ACTION BAR ── */
        #action-bar { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg-primary); border-top: 1px solid var(--border-secondary); }
        .ab-left { display: flex; align-items: center; }
        .ab-right { display: flex; align-items: center; gap: 7px; }
        #action-bar button { background: linear-gradient(to bottom, var(--btn-g1), var(--btn-g2), var(--btn-g3)); color: var(--text-btn); border: 1px solid var(--border-accent); border-radius: 4px; padding: 8px 14px; cursor: pointer; font-size: 12.5px; font-weight: 500; font-family: inherit; display: flex; align-items: center; justify-content: center; transition: all .2s; }
        #action-bar button:hover { background: linear-gradient(to bottom, var(--btn-hg1), var(--btn-hg2), var(--btn-hg3)); color: var(--text-btn-h); }
        #action-bar button svg { width: 16px; height: 16px; stroke: var(--icon-btn); stroke-width: 1.5; fill: none; margin-right: 7px; transition: stroke .2s; }
        #action-bar button:hover svg { stroke: var(--icon-btn-h); }

        /* Attach group */
        #attach-group { display: flex; align-items: stretch; position: relative; }
        #attach-btn { border-radius: 4px 0 0 4px !important; border-right: none !important; }
        #attach-btn.attached { border-color: var(--accent-dim) !important; color: var(--accent) !important; }
        #attach-btn.attached svg { stroke: var(--accent) !important; }
        #attach-caret { background: linear-gradient(to bottom, var(--btn-g1), var(--btn-g3)); border: 1px solid var(--border-accent); border-left: 1px solid var(--border-secondary) !important; border-radius: 0 4px 4px 0 !important; padding: 8px 9px !important; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .2s; }
        #attach-caret:hover { background: linear-gradient(to bottom, var(--btn-hg1), var(--btn-hg3)); }
        #attach-caret.attached { border-color: var(--accent-dim) !important; }
        #attach-caret svg { width: 11px !important; height: 11px !important; margin: 0 !important; stroke: var(--icon-btn); stroke-width: 2.5; fill: none; }

        /* Dropdown */
        #attach-dd { position: absolute; bottom: calc(100% + 6px); left: 0; background: var(--dd-bg); border: 1px solid var(--dd-border); border-radius: 8px; min-width: 215px; box-shadow: 0 10px 30px rgba(0,0,0,.6); z-index: 9000; overflow: hidden; display: none; flex-direction: column; }
        #attach-dd.open { display: flex; animation: dropup .12s ease; }
        @keyframes dropup { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        .dd-section-lbl { font-size: 10px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--text-tertiary); padding: 10px 12px 4px; }
        .dd-port { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; cursor: pointer; transition: background .1s; }
        .dd-port:hover { background: var(--dd-hover); }
        .dd-port-left { display: flex; align-items: center; gap: 8px; font-size: 12.5px; color: var(--dd-text); }
        .dd-port-dot { width: 6px; height: 6px; border-radius: 50%; background: #444; flex-shrink: 0; transition: background .3s; }
        .dd-port.open .dd-port-dot { background: var(--accent); }
        .dd-port.connected-port { background: rgba(160,160,160,.06); }
        .dd-port.connected-port .dd-port-left { color: var(--accent); font-weight: 600; }
        .dd-port-badge { font-size: 10px; color: var(--text-tertiary); background: var(--bg-tertiary); border-radius: 3px; padding: 1px 5px; }
        .dd-divider { height: 1px; background: var(--dd-border); margin: 3px 0; }
        .dd-action { display: flex; align-items: center; gap: 9px; padding: 9px 12px; cursor: pointer; font-size: 12.5px; color: var(--dd-text); transition: background .1s; }
        .dd-action:hover { background: var(--dd-hover); }
        .dd-action svg { width: 14px; height: 14px; stroke: var(--icon-primary); stroke-width: 2; fill: none; flex-shrink: 0; }
        .dd-action.danger { color: var(--red); }
        .dd-action.danger svg { stroke: var(--red); }

        /* ── MODAL ── */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: flex; align-items: center; justify-content: center; z-index: 99999; }
        .modal-box { background: var(--bg-secondary); border: 1px solid var(--border-accent); border-radius: 10px; padding: 22px 26px; min-width: 260px; max-width: 400px; box-shadow: 0 14px 42px rgba(0,0,0,.6); display: flex; flex-direction: column; gap: 14px; }
        .modal-box p { margin: 0; color: var(--text-primary); font-size: 13px; line-height: 1.55; }
        .modal-box button { align-self: flex-end; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-accent); border-radius: 5px; padding: 7px 20px; cursor: pointer; font-size: 13px; font-family: inherit; }
        .modal-box button:hover { background: var(--bg-accent); }
    </style>
</head>
<body>
<div id="app-container">

    <!-- TITLE BAR -->
    <header id="app-header">
        <div class="title-bar">
            <div class="title-left-group"><span class="title">Potassium</span></div>
            <div class="top-center-actions">
                <div class="action-icon-wrapper" id="nav-editor">
                    <svg viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3"/><path d="M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3"/></svg>
                </div>
                <div class="action-icon-wrapper wrench-icon" id="nav-settings">
                    <svg viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                </div>
                <div class="action-icon-wrapper palette-icon" id="nav-theme">
                    <svg viewBox="0 0 24 24">
                        <circle cx="13.5" cy="6.5" r="1.5"/><circle cx="17.5" cy="10.5" r="1.5"/>
                        <circle cx="8.5" cy="7.5" r="1.5"/><circle cx="6.5" cy="12.5" r="1.5"/>
                        <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>
                    </svg>
                </div>
            </div>
            <div class="title-bar-window-controls">
                <svg id="wcbtn-min" viewBox="0 0 24 24" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                <svg id="wcbtn-max" viewBox="0 0 24 24" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                <svg id="wcbtn-close" viewBox="0 0 24 24" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </div>
        </div>

        <!-- TAB BAR -->
        <div id="tab-bar">
            <div id="tabs-and-add">
                <div id="tabs-container"></div>
                <button id="add-tab-btn" title="New tab">+</button>
            </div>
            <div id="tab-bar-search-container">
                <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="tab-bar-search-input">
            </div>
        </div>
    </header>


    <!-- BODY -->
    <div id="app-body">

        <!-- Editor -->
        <div id="editor-view">
            <main id="main-editor"><div id="monaco-container"></div></main>
            <div id="right-sidebar"></div>
        </div>

        <!-- Settings -->
        <div id="settings-view">

            <p class="sec-title">Connection</p>
            <div class="sec-divider"></div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">Status</span><span class="desc">Current connection state</span></div>
                <span class="status-pill" id="status-pill"><span class="dot"></span><span id="status-text">Disconnected</span></span>
            </div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">Port</span><span class="desc">Target port for attachment</span></div>
                <div class="cdd-wrap" id="cdd-port">
                    <div class="cdd-trigger" id="cdd-port-trigger">
                        <div class="cdd-trigger-left">
                            <span class="cdd-trigger-dot" id="cdd-port-dot"></span>
                            <span class="cdd-trigger-text" id="cdd-port-label">Port 8392</span>
                        </div>
                        <svg class="cdd-caret" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="cdd-panel" id="cdd-port-panel">
                        <div class="cdd-section-lbl">Available Ports</div>
                        <!-- populated by JS -->
                    </div>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">Attach</span><span class="desc">Select an action — fires immediately on pick</span></div>
                <div class="cdd-wrap" id="cdd-attach">
                    <div class="cdd-trigger" id="cdd-attach-trigger">
                        <div class="cdd-trigger-left">
                            <span class="cdd-trigger-text" id="cdd-attach-label">Attach to Selected Port</span>
                        </div>
                        <svg class="cdd-caret" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="cdd-panel" id="cdd-attach-panel">
                        <div class="cdd-item" data-action="selected">
                            <div class="cdd-item-left">
                                <svg class="cdd-item-icon" viewBox="0 0 24 24"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                                Attach to Selected Port
                            </div>
                        </div>
                        <div class="cdd-item" data-action="any">
                            <div class="cdd-item-left">
                                <svg class="cdd-item-icon" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                Attach to Any Available
                            </div>
                        </div>
                        <div class="cdd-divider"></div>
                        <div class="cdd-item danger" data-action="detach">
                            <div class="cdd-item-left">
                                <svg class="cdd-item-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                Detach
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">Execute To</span><span class="desc">Which port(s) receive scripts on Execute</span></div>
                <div class="cdd-wrap" id="cdd-execute">
                    <div class="cdd-trigger" id="cdd-execute-trigger">
                        <div class="cdd-trigger-left">
                            <span class="cdd-trigger-text" id="cdd-execute-label">Selected Port</span>
                        </div>
                        <svg class="cdd-caret" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="cdd-panel" id="cdd-execute-panel">
                        <div class="cdd-item active" data-value="selected">
                            <div class="cdd-item-left">
                                <svg class="cdd-item-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8" fill="currentColor" stroke="none"/></svg>
                                Selected Port
                            </div>
                        </div>
                        <div class="cdd-item" data-value="ALL">
                            <div class="cdd-item-left">
                                <svg class="cdd-item-icon" viewBox="0 0 24 24"><path d="M5 12h14"/><circle cx="19" cy="12" r="2"/><circle cx="5" cy="12" r="2"/></svg>
                                All Ports
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">Auto Attach</span><span class="desc">Reconnect automatically when Roblox opens</span></div>
                <label class="toggle-switch"><input type="checkbox" id="tog-auto-attach"><span class="slider"></span></label>
            </div>

            <p class="sec-title">Editor</p>
            <div class="sec-divider"></div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">Minimap</span><span class="desc">Show the code minimap on the right side</span></div>
                <label class="toggle-switch"><input type="checkbox" id="tog-minimap"><span class="slider"></span></label>
            </div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">Line Numbers</span><span class="desc">Show line numbers in the editor gutter</span></div>
                <label class="toggle-switch"><input type="checkbox" id="tog-linenums" checked><span class="slider"></span></label>
            </div>

            <p class="sec-title">Window</p>
            <div class="sec-divider"></div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">Always on Top</span><span class="desc">Keep Potassium above all other windows</span></div>
                <label class="toggle-switch"><input type="checkbox" id="tog-aot"><span class="slider"></span></label>
            </div>

            <p class="sec-title">Execution API</p>
            <div class="sec-divider"></div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">API Backend</span><span class="desc">Choose which execution API to use</span></div>
                <div class="cdd-wrap" id="cdd-api">
                    <div class="cdd-trigger" id="cdd-api-trigger">
                        <div class="cdd-trigger-left">
                            <span class="cdd-trigger-text" id="cdd-api-label">Rust API</span>
                        </div>
                        <svg class="cdd-caret" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="cdd-panel" id="cdd-api-panel">
                        <div class="cdd-item active" data-value="rust">
                            <div class="cdd-item-left">
                                <svg class="cdd-item-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                Rust API
                            </div>
                            <span class="cdd-item-badge">native</span>
                        </div>
                        <div class="cdd-item" data-value="js">
                            <div class="cdd-item-left">
                                <svg class="cdd-item-icon" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                                JavaScript API
                            </div>
                            <span class="cdd-item-badge">node</span>
                        </div>
                    </div>
                </div>
            </div>

            <p class="sec-title">Notifications</p>
            <div class="sec-divider"></div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">Execute Notifications</span><span class="desc">Show result modal after executing a script</span></div>
                <label class="toggle-switch"><input type="checkbox" id="tog-notif-execute" checked><span class="slider"></span></label>
            </div>

            <div class="setting-row">
                <div class="setting-label"><span class="lbl">Attach Notifications</span><span class="desc">Show modal when attaching or detaching</span></div>
                <label class="toggle-switch"><input type="checkbox" id="tog-notif-attach" checked><span class="slider"></span></label>
            </div>

        </div>

        <!-- Theme -->
        <div id="theme-view">
            <p class="sec-title">Appearance</p>
            <div class="sec-divider"></div>
            <div class="theme-options">
                <div class="theme-opt" id="theme-dark">
                    <div class="theme-preview tp-dark"><div class="ph"></div><div class="pb"></div></div>
                    <span class="theme-lbl">Default Dark</span>
                </div>
                <div class="theme-opt" id="theme-light">
                    <div class="theme-preview tp-light"><div class="ph"></div><div class="pb"></div></div>
                    <span class="theme-lbl">Light Theme</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ACTION BAR -->
    <footer id="action-bar">
        <div class="ab-left">
            <!-- Attach group: main button + caret for dropdown -->
            <div id="attach-group">
                <button id="attach-btn">
                    <svg viewBox="0 0 24 24"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                    Attach
                </button>
                <button id="attach-caret">
                    <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                </button>

                <!-- Dropdown (opens upward) -->
                <div id="attach-dd">
                    <div class="dd-section-lbl">Ports</div>
                    <div id="dd-port-list"></div>
                    <div class="dd-divider"></div>
                    <div class="dd-action" id="dd-attach-any">
                        <svg viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                        Attach to Any Available
                    </div>
                    <div class="dd-action danger" id="dd-detach">
                        <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        Detach
                    </div>
                </div>
            </div>
        </div>

        <div class="ab-right">
            <button id="btn-execute">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8" fill="currentColor" stroke="none"/></svg>
                Execute
            </button>
            <button id="btn-clear">
                <svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                Clear
            </button>
            <button id="btn-open">
                <svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                Open
            </button>
            <button id="btn-save">
                <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                Save
            </button>
        </div>
    </footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/loader.min.js"></script>
<script>
'use strict';

// ══════════════════════════════
// STATE
// ══════════════════════════════
const ALL_PORTS = ['8392','8393','8394','8395','8396','8397'];
let monacoEditor = null;
let tabs = [], activeTabId = null, tabCounter = 0;
const initialContent = '-- Potassium\n';

let connectedPort = null;
let selectedPort  = '8392';   // currently selected port in settings
let executeTarget = 'selected'; // 'selected' | 'ALL'
let attachMode    = 'selected'; // 'selected' | 'any' (controls Attach button + auto-attach behavior)
let autoAttachTimer = null;
let mainDdOpen = false;
let portStatusCache = {};   // port => true/false
let apiBackend = 'rust';    // 'rust' | 'js'
let notifExecute = true;    // show modal after execute
let notifAttach  = true;    // show modal after attach/detach
let themeName    = 'dark';  // 'dark' | 'light'
let settingsApplying = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS (persistence)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SETTINGS_KEY = 'potassium.settings.v1';

function loadSettings() {
    try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : {};
    } catch(_) { return {}; }
}

function saveSettings() {
    const data = {
        selectedPort,
        executeTarget,
        attachMode,
        apiBackend,
        notifExecute,
        notifAttach,
        themeName,
        autoAttach:  !!document.getElementById('tog-auto-attach')?.checked,
        minimap:     !!document.getElementById('tog-minimap')?.checked,
        lineNums:    !!document.getElementById('tog-linenums')?.checked,
        alwaysOnTop: !!document.getElementById('tog-aot')?.checked,
    };
    try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(data)); } catch(_) {}
}

function applySettings(s) {
    settingsApplying = true;
    try {
        if (s?.selectedPort && ALL_PORTS.includes(String(s.selectedPort))) selectedPort = String(s.selectedPort);
        if (s?.executeTarget === 'ALL' || s?.executeTarget === 'selected') executeTarget = s.executeTarget;
        if (s?.attachMode === 'any' || s?.attachMode === 'selected') attachMode = s.attachMode;
        if (s?.apiBackend === 'js' || s?.apiBackend === 'rust') apiBackend = s.apiBackend;
        if (typeof s?.notifExecute === 'boolean') notifExecute = s.notifExecute;
        if (typeof s?.notifAttach === 'boolean')  notifAttach  = s.notifAttach;
        if (s?.themeName === 'light' || s?.themeName === 'dark') themeName = s.themeName;

        // Theme
        applyTheme(themeName);

        // Checkboxes
        const autoAttachEl = document.getElementById('tog-auto-attach');
        const minimapEl    = document.getElementById('tog-minimap');
        const lineNumsEl   = document.getElementById('tog-linenums');
        const aotEl        = document.getElementById('tog-aot');
        const neEl         = document.getElementById('tog-notif-execute');
        const naEl         = document.getElementById('tog-notif-attach');

        if (autoAttachEl && typeof s?.autoAttach === 'boolean') autoAttachEl.checked = s.autoAttach;
        if (minimapEl    && typeof s?.minimap === 'boolean')    minimapEl.checked    = s.minimap;
        if (lineNumsEl   && typeof s?.lineNums === 'boolean')   lineNumsEl.checked   = s.lineNums;
        if (aotEl        && typeof s?.alwaysOnTop === 'boolean') aotEl.checked       = s.alwaysOnTop;
        if (neEl) neEl.checked = !!notifExecute;
        if (naEl) naEl.checked = !!notifAttach;

        // Monaco editor options
        monacoEditor?.updateOptions({
            minimap: { enabled: !!minimapEl?.checked },
            lineNumbers: !!lineNumsEl?.checked ? 'on' : 'off',
        });

        // Always on top (best-effort)
        tauriInvoke('set_always_on_top', { value: !!aotEl?.checked }).catch(() => {});

        // Execute CDD label + active state
        const execLabel = document.getElementById('cdd-execute-label');
        if (execLabel) execLabel.textContent = executeTarget === 'ALL' ? 'All Ports' : 'Selected Port';
        document.querySelectorAll('#cdd-execute-panel .cdd-item').forEach(el => {
            el.classList.toggle('active', el.dataset.value === executeTarget);
        });

        // API CDD label + active state
        const apiLabel = document.getElementById('cdd-api-label');
        if (apiLabel) apiLabel.textContent = apiBackend === 'js' ? 'JavaScript API' : 'Rust API';
        document.querySelectorAll('#cdd-api-panel .cdd-item').forEach(el => {
            el.classList.toggle('active', el.dataset.value === apiBackend);
        });

        // Attach CDD label + active state
        const attachLabel = document.getElementById('cdd-attach-label');
        if (attachLabel) attachLabel.textContent = attachMode === 'any' ? 'Attach to Any Available' : 'Attach to Selected Port';
        document.querySelectorAll('#cdd-attach-panel .cdd-item').forEach(el => {
            const action = el.dataset.action;
            el.classList.toggle('active', (action === 'selected' && attachMode === 'selected') || (action === 'any' && attachMode === 'any'));
        });

        // Port CDD
        renderPortCddPanel();
        refreshPortCddTrigger();

        // Auto-attach
        if (autoAttachEl?.checked) startAutoAttach(true);
        else stopAutoAttach();
    } finally {
        settingsApplying = false;
    }
}

// ══════════════════════════════
// TAURI
// ══════════════════════════════
function tauriInvoke(cmd, args) {
    const fn = window.__TAURI__?.core?.invoke
            ?? window.__TAURI__?.tauri?.invoke
            ?? window.__TAURI__?.invoke;
    if (!fn) return Promise.reject('Tauri not available — check window.__TAURI__');
    console.log('[Tauri invoke]', cmd, JSON.stringify(args ?? {}));
    return fn(cmd, args ?? {});
}

// ══════════════════════════════════════════════════════════════
// JS API — pure JavaScript implementation using Node net + zlib
// Exposed via Tauri's invoke bridge to js_api_call command.
// All attach / detach / execute / check_port operations route
// through here when apiBackend === 'js'.
// ══════════════════════════════════════════════════════════════

// Low-level: send one operation through the Rust js_api_call bridge
// which runs the actual Node net+zlib logic server-side.
// Command signature: js_api_call(op: String, code: String, port: String) -> String
async function jsApiBridge(op, code, port) {
    try {
        return await tauriInvoke('js_api_call', { op, code, port });
    } catch(e) {
        console.warn('[JS API] bridge error, falling back to Rust API:', e);
        // Fallback to matching Rust command
        if (op === 'execute') return await tauriInvoke('OpiumwareExecution', { code, port });
        if (op === 'attach')  return await tauriInvoke('OpiumwareAttach');
        if (op === 'detach')  return await tauriInvoke('OpiumwareDetach', { port });
        if (op === 'check')   return await tauriInvoke('check_port', { port });
        return 'Error: unknown op ' + op;
    }
}

// JS API — execute script on port(s)
async function jsApiExecute(code, port) {
    return await jsApiBridge('execute', code, port);
}

// JS API — attach: scan all ports, return first reachable
async function jsApiAttach() {
    return await jsApiBridge('attach', 'NULL', 'ALL');
}

// JS API — attach to specific port (probe with NULL script)
async function jsApiAttachToPort(port) {
    return await jsApiBridge('execute', 'NULL', port);
}

// JS API — detach (just ends logical connection, no data sent)
async function jsApiDetach(port) {
    return await jsApiBridge('detach', '', port);
}

// JS API — check if a port is open
async function jsApiCheckPort(port) {
    const result = await jsApiBridge('check', '', port);
    return result === 'true' || result === true;
}

// ══════════════════════════════
// MODAL
// ══════════════════════════════
function modal(msg) {
    document.querySelector('.modal-overlay')?.remove();
    const ov = document.createElement('div'); ov.className = 'modal-overlay';
    const box = document.createElement('div'); box.className = 'modal-box';
    const p = document.createElement('p'); p.textContent = msg;
    const btn = document.createElement('button'); btn.textContent = 'OK';
    btn.onclick = () => ov.remove();
    ov.onclick = e => { if (e.target === ov) ov.remove(); };
    box.append(p, btn); ov.appendChild(box);
    document.body.appendChild(ov); btn.focus();
}

// SCRIPT NORMALIZATION
function toOpiumwarePacket(editorCode) {
    const code = String(editorCode ?? '').trim();
    if (!code) return '';
    if (code === 'NULL') return 'NULL';
    if (/^Opiumware(?:Script|Setting)\b/.test(code)) return code;
    return 'OpiumwareScript ' + code;
}

// ══════════════════════════════
// CONNECTION STATE
// ══════════════════════════════
function setConnectedPort(port) {
    connectedPort = port;
    const pill = document.getElementById('status-pill');
    const text = document.getElementById('status-text');
    if (port) {
        pill?.classList.add('connected');
        if (text) text.textContent = 'Port ' + port;
        selectedPort = port;
    } else {
        pill?.classList.remove('connected');
        if (text) text.textContent = 'Disconnected';
    }
    document.getElementById('attach-btn')?.classList.toggle('attached', !!port);
    document.getElementById('attach-caret')?.classList.toggle('attached', !!port);
    refreshPortCddTrigger();
    renderMainDdPorts();
    renderPortCddPanel();
    if (!settingsApplying) saveSettings();
}

// ══════════════════════════════
// ATTACH LOGIC
// ══════════════════════════════
async function attachToPort(port, silent = false) {
    try {
        const result = apiBackend === 'js'
            ? await jsApiAttachToPort(port)
            : await tauriInvoke('OpiumwareExecution', { code: 'NULL', port });
        if (result?.toLowerCase().includes('success')) {
            setConnectedPort(port);
            if (!silent && notifAttach) modal('Attached to port ' + port);
            return true;
        }
        setConnectedPort(null);
        if (!silent && notifAttach) modal(result || 'Failed to connect to port ' + port);
        return false;
    } catch(e) {
        setConnectedPort(null);
        if (!silent && notifAttach) modal('Attach error: ' + e);
        return false;
    }
}

async function attachToAny(silent = false) {
    try {
        const result = apiBackend === 'js'
            ? await jsApiAttach()
            : await tauriInvoke('OpiumwareAttach');
        if (result?.toLowerCase().includes('success')) {
            const m = result.match(/port[:\s]+(\d+)/i);
            setConnectedPort(m ? m[1] : ALL_PORTS[0]);
            if (!silent && notifAttach) modal(result);
            return true;
        }
        setConnectedPort(null);
        if (!silent && notifAttach) modal(result || 'No available port found.');
        return false;
    } catch(e) {
        setConnectedPort(null);
        if (!silent && notifAttach) modal('Attach error: ' + e);
        return false;
    }
}

async function detach() {
    if (connectedPort) {
        try {
            if (apiBackend === 'js') {
                await jsApiDetach(connectedPort);
            } else {
                await tauriInvoke('OpiumwareDetach', { port: connectedPort });
            }
        } catch(_) {}
    }
    setConnectedPort(null);
}

// ══════════════════════════════
// AUTO ATTACH
// ══════════════════════════════
function startAutoAttach(silent = false) {
    if (autoAttachTimer) return;

    // Try once immediately, then keep retrying.
    if (!connectedPort) {
        if (attachMode === 'any') attachToAny(true);
        else attachToPort(selectedPort, true);
    }

    autoAttachTimer = setInterval(() => {
        if (connectedPort) return;
        if (attachMode === 'any') attachToAny(true);
        else attachToPort(selectedPort, true);
    }, 3000);

    if (!silent && notifAttach) modal('Auto attach enabled.');
}
function stopAutoAttach() { clearInterval(autoAttachTimer); autoAttachTimer = null; }

// ══════════════════════════════
// PORT SCAN
// ══════════════════════════════
async function scanPorts() {
    await Promise.allSettled(ALL_PORTS.map(async p => {
        try {
            if (apiBackend === 'js') {
                portStatusCache[p] = await jsApiCheckPort(p);
            } else {
                portStatusCache[p] = !!(await tauriInvoke('check_port', { port: p }));
            }
        } catch(_) { portStatusCache[p] = false; }
    }));
    renderMainDdPorts();
    renderPortCddPanel();
    refreshPortCddTrigger();
}

// ══════════════════════════════
// MAIN ACTION BAR DROPDOWN (attach-dd)
// ══════════════════════════════
function renderMainDdPorts() {
    const list = document.getElementById('dd-port-list');
    if (!list) return;
    list.innerHTML = '';
    ALL_PORTS.forEach(p => {
        const isOpen = portStatusCache[p] ?? false;
        const isConn = connectedPort === p;
        const item = document.createElement('div');
        item.className = 'dd-port' + (isOpen ? ' open' : '') + (isConn ? ' connected-port' : '');
        const dot = document.createElement('span'); dot.className = 'dd-port-dot';
        const lbl = document.createElement('span'); lbl.className = 'dd-port-left';
        lbl.append(dot, document.createTextNode('Port ' + p));
        const badge = document.createElement('span'); badge.className = 'dd-port-badge';
        badge.textContent = isConn ? 'connected' : (isOpen ? 'open' : 'closed');
        item.append(lbl, badge);
        item.addEventListener('click', async () => { closeMainDd(); await attachToPort(p); });
        list.appendChild(item);
    });
}

function openMainDd()  { document.getElementById('attach-dd').classList.add('open'); mainDdOpen = true; scanPorts(); }
function closeMainDd() { document.getElementById('attach-dd').classList.remove('open'); mainDdOpen = false; }
function toggleMainDd() { mainDdOpen ? closeMainDd() : openMainDd(); }

// ══════════════════════════════
// CUSTOM DROPDOWN HELPER
// ══════════════════════════════
// Tracks which cdd panels are open so we can close others
const openCdds = new Set();

function openCdd(panelId, triggerId) {
    // Close all other cdds first
    openCdds.forEach(id => {
        if (id !== panelId) {
            document.getElementById(id)?.classList.remove('open');
            document.getElementById(id.replace('-panel','-trigger'))?.classList.remove('open');
            openCdds.delete(id);
        }
    });
    document.getElementById(panelId)?.classList.add('open');
    document.getElementById(triggerId)?.classList.add('open');
    openCdds.add(panelId);
}
function closeCdd(panelId, triggerId) {
    document.getElementById(panelId)?.classList.remove('open');
    document.getElementById(triggerId)?.classList.remove('open');
    openCdds.delete(panelId);
}
function toggleCdd(panelId, triggerId) {
    if (openCdds.has(panelId)) closeCdd(panelId, triggerId);
    else openCdd(panelId, triggerId);
}

// Close all cdds on outside click
document.addEventListener('click', e => {
    // Close main dropdown
    if (mainDdOpen && !document.getElementById('attach-group')?.contains(e.target)) closeMainDd();
    // Close all custom dropdowns
    [...openCdds].forEach(panelId => {
        const trigger = document.getElementById(panelId.replace('-panel','-trigger'));
        const panel = document.getElementById(panelId);
        if (!panel?.contains(e.target) && !trigger?.contains(e.target)) {
            closeCdd(panelId, panelId.replace('-panel','-trigger'));
        }
    });
});

// ══════════════════════════════
// PORT CDD (settings port picker)
// ══════════════════════════════
function renderPortCddPanel() {
    const panel = document.getElementById('cdd-port-panel');
    if (!panel) return;
    // Keep the section label, rebuild items after it
    const sectionLbl = panel.querySelector('.cdd-section-lbl');
    // Remove all items
    panel.querySelectorAll('.cdd-item, .cdd-divider').forEach(el => el.remove());

    ALL_PORTS.forEach(p => {
        const isOpen = portStatusCache[p] ?? false;
        const isConn = connectedPort === p;
        const isSel  = selectedPort === p;

        const item = document.createElement('div');
        item.className = 'cdd-item' + (isSel ? ' active' : '');

        const dot = document.createElement('span');
        dot.className = 'cdd-item-dot' + (isOpen || isConn ? ' port-open' : '');

        const left = document.createElement('div'); left.className = 'cdd-item-left';
        left.append(dot, document.createTextNode('Port ' + p));

        const badge = document.createElement('span');
        badge.className = 'cdd-item-badge' + (isConn ? ' is-connected' : '');
        badge.textContent = isConn ? 'connected' : (isOpen ? 'open' : 'closed');

        item.append(left, badge);
        item.addEventListener('click', () => {
            selectedPort = p;
            closeCdd('cdd-port-panel', 'cdd-port-trigger');
            refreshPortCddTrigger();
            renderPortCddPanel();
            if (!settingsApplying) saveSettings();
        });
        panel.appendChild(item);
    });
}

function refreshPortCddTrigger() {
    const label = document.getElementById('cdd-port-label');
    const dot   = document.getElementById('cdd-port-dot');
    if (label) label.textContent = 'Port ' + selectedPort;
    if (dot) {
        const isConn = connectedPort === selectedPort;
        const isOpen = portStatusCache[selectedPort] ?? false;
        dot.className = 'cdd-trigger-dot' + (isConn || isOpen ? ' on' : '');
    }
}

// ══════════════════════════════
// EXECUTE CDD
// ══════════════════════════════
function setupExecuteCdd() {
    const panel = document.getElementById('cdd-execute-panel');
    panel?.querySelectorAll('.cdd-item').forEach(item => {
        item.addEventListener('click', () => {
            executeTarget = item.dataset.value;
            document.getElementById('cdd-execute-label').textContent = item.querySelector('.cdd-item-left').textContent.trim();
            panel.querySelectorAll('.cdd-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            closeCdd('cdd-execute-panel', 'cdd-execute-trigger');
            if (!settingsApplying) saveSettings();
        });
    });
}

// ══════════════════════════════
// ATTACH CDD (settings)
// ══════════════════════════════
function setupAttachCdd() {
    const panel = document.getElementById('cdd-attach-panel');
    panel?.querySelectorAll('.cdd-item').forEach(item => {
        item.addEventListener('click', async () => {
            const action = item.dataset.action;
            const labelEl = document.getElementById('cdd-attach-label');
            closeCdd('cdd-attach-panel', 'cdd-attach-trigger');

            if (action === 'selected') {
                attachMode = 'selected';
                if (labelEl) labelEl.textContent = item.querySelector('.cdd-item-left').textContent.trim();
                panel.querySelectorAll('.cdd-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                if (!settingsApplying) saveSettings();
                await attachToPort(selectedPort);
            } else if (action === 'any') {
                attachMode = 'any';
                if (labelEl) labelEl.textContent = item.querySelector('.cdd-item-left').textContent.trim();
                panel.querySelectorAll('.cdd-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                if (!settingsApplying) saveSettings();
                await attachToAny(false);
            } else if (action === 'detach') {
                await detach();
                modal('Detached.');
            }
        });
    });
}

// ══════════════════════════════
// TABS
// ══════════════════════════════
const tabsContainer = document.getElementById('tabs-container');

function renderTabs() {
    tabsContainer.innerHTML = '';
    tabs.forEach((tab, idx) => {
        const el = document.createElement('div');
        el.className = 'tab' + (tab.id === activeTabId ? ' active' : '');
        el.title = tab.name;
        const icon = document.createElementNS('http://www.w3.org/2000/svg','svg');
        icon.setAttribute('class','tab-icon'); icon.setAttribute('viewBox','0 0 24 24'); icon.setAttribute('fill','currentColor');
        icon.innerHTML = '<path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"/>';
        el.appendChild(icon);
        const name = document.createElement('span'); name.className = 'tab-name'; name.textContent = tab.name;
        name.addEventListener('dblclick', () => startRename(tab, name));
        el.appendChild(name);
        if (idx !== 0) {
            const x = document.createElement('button'); x.className = 'tab-close-btn'; x.innerHTML = '&times;'; x.title = 'Close';
            x.onclick = e => { e.stopPropagation(); removeTab(tab.id); };
            el.appendChild(x);
        }
        el.onclick = () => switchTab(tab.id);
        tabsContainer.appendChild(el);
    });
}

function addTab(name = null, content = null) {
    tabCounter++;
    const id = 'tab-' + tabCounter;
    tabs.push({ id, name: name || 'Untitled Tab ' + tabCounter, content: content ?? initialContent });
    switchTab(id);
}
function switchTab(id) {
    activeTabId = id;
    const tab = tabs.find(t => t.id === id);
    if (tab && monacoEditor) { monacoEditor.setValue(tab.content || ''); monacoEditor.focus(); }
    renderTabs();
}
function removeTab(id) {
    const idx = tabs.findIndex(t => t.id === id);
    if (idx <= 0) return;
    tabs.splice(idx, 1);
    if (tabs.length === 1) tabCounter = 1;
    if (activeTabId === id) switchTab(tabs[Math.max(0, idx - 1)].id);
    else renderTabs();
}
function startRename(tab, span) {
    span.style.display = 'none';
    const inp = document.createElement('input'); inp.type='text'; inp.className='tab-name-input'; inp.value=tab.name;
    span.parentNode.insertBefore(inp, span); inp.focus(); inp.select();
    const done = () => { tab.name = inp.value.trim() || tab.name; inp.remove(); span.textContent=tab.name; span.style.display=''; };
    inp.addEventListener('blur', done);
    inp.addEventListener('keydown', e => { if(e.key==='Enter') done(); if(e.key==='Escape'){inp.remove();span.style.display='';} });
}

// ══════════════════════════════
// VIEWS
// ══════════════════════════════
const $ = id => document.getElementById(id);
let appContainer, editorView, settingsView, themeView, tabBar, actionBar, appBody;
let navEditor, navSettings, navTheme;

function showEditor()   { editorView.style.display='flex'; settingsView.style.display='none'; themeView.style.display='none'; tabBar.style.display='flex'; actionBar.style.display='flex'; appBody.className=''; }
function showSettings() { editorView.style.display='none'; settingsView.style.display='block'; themeView.style.display='none'; tabBar.style.display='none'; actionBar.style.display='none'; appBody.className='settings-active'; scanPorts(); }
function showTheme()    { editorView.style.display='none'; settingsView.style.display='none'; themeView.style.display='block'; tabBar.style.display='none'; actionBar.style.display='none'; appBody.className='theme-active'; }
function setNav(active) { [navEditor,navSettings,navTheme].forEach(n=>n.classList.remove('active-section-indicator')); active.classList.add('active-section-indicator'); }

function applyTheme(name) {
    themeName = name === 'light' ? 'light' : 'dark';
    appContainer.classList.toggle('light-theme', name==='light');
    document.querySelectorAll('.theme-opt').forEach(e=>e.classList.remove('active-theme'));
    if (name==='light') { $('theme-light')?.classList.add('active-theme'); if(monacoEditor) monaco.editor.setTheme('vs'); }
    else                { $('theme-dark')?.classList.add('active-theme');  if(monacoEditor) monaco.editor.setTheme('vs-dark'); }
    if (!settingsApplying) saveSettings();
}

// ══════════════════════════════
// INIT
// ══════════════════════════════
function init() {
    appContainer = $('app-container');
    editorView   = $('editor-view');
    settingsView = $('settings-view');
    themeView    = $('theme-view');
    tabBar       = $('tab-bar');
    actionBar    = $('action-bar');
    appBody      = $('app-body');
    navEditor    = $('nav-editor');
    navSettings  = $('nav-settings');
    navTheme     = $('nav-theme');

    navEditor.classList.add('active-section-indicator');
    showEditor();

    // Apply persisted settings (theme, toggles, dropdowns, etc.)
    applySettings(loadSettings());

    // Nav
    navEditor.onclick   = () => { showEditor();   setNav(navEditor); };
    navSettings.onclick = () => { showSettings(); setNav(navSettings); };
    navTheme.onclick    = () => { showTheme();    setNav(navTheme); };

    // Theme
    $('theme-dark').onclick  = () => applyTheme('dark');
    $('theme-light').onclick = () => applyTheme('light');

    // Editor toggles
    $('tog-minimap').addEventListener('change', e => { monacoEditor?.updateOptions({ minimap: { enabled: e.target.checked } }); if(!settingsApplying) saveSettings(); });
    $('tog-linenums').addEventListener('change', e => { monacoEditor?.updateOptions({ lineNumbers: e.target.checked ? 'on' : 'off' }); if(!settingsApplying) saveSettings(); });

    // Always on top
    $('tog-aot').addEventListener('change', async e => {
        try { await tauriInvoke('set_always_on_top', { value: e.target.checked }); } catch(_) {}
        if(!settingsApplying) saveSettings();
    });

    // Auto Attach
    $('tog-auto-attach').addEventListener('change', e => { e.target.checked ? startAutoAttach(false) : stopAutoAttach(); if(!settingsApplying) saveSettings(); });

    // API Backend CDD
    $('cdd-api-trigger').onclick = e => { e.stopPropagation(); toggleCdd('cdd-api-panel','cdd-api-trigger'); };
    document.getElementById('cdd-api-panel')?.querySelectorAll('.cdd-item').forEach(item => {
        item.addEventListener('click', () => {
            apiBackend = item.dataset.value;
            document.getElementById('cdd-api-label').textContent = item.querySelector('.cdd-item-left').textContent.trim();
            document.getElementById('cdd-api-panel').querySelectorAll('.cdd-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            closeCdd('cdd-api-panel', 'cdd-api-trigger');
            console.log('[Settings] API backend set to:', apiBackend);
            if(!settingsApplying) saveSettings();
        });
    });

    // Notification toggles
    $('tog-notif-execute').addEventListener('change', e => { notifExecute = e.target.checked; if(!settingsApplying) saveSettings(); });
    $('tog-notif-attach').addEventListener('change',  e => { notifAttach  = e.target.checked; if(!settingsApplying) saveSettings(); });

    // ── Custom dropdowns ──
    // Port CDD
    $('cdd-port-trigger').onclick = e => { e.stopPropagation(); toggleCdd('cdd-port-panel','cdd-port-trigger'); if(openCdds.has('cdd-port-panel')) scanPorts(); };
    renderPortCddPanel();
    refreshPortCddTrigger();

    // Attach CDD
    $('cdd-attach-trigger').onclick = e => { e.stopPropagation(); toggleCdd('cdd-attach-panel','cdd-attach-trigger'); };
    setupAttachCdd();

    // Execute CDD
    $('cdd-execute-trigger').onclick = e => { e.stopPropagation(); toggleCdd('cdd-execute-panel','cdd-execute-trigger'); };
    setupExecuteCdd();

    // ── Main action-bar Attach button + caret ──
    $('attach-btn').onclick = () => (attachMode === 'any' ? attachToAny(false) : attachToPort(selectedPort, false));
    $('attach-caret').onclick = e => { e.stopPropagation(); toggleMainDd(); };
    $('dd-attach-any').onclick = () => { closeMainDd(); attachToAny(false); };
    $('dd-detach').onclick     = () => { closeMainDd(); detach(); };

    // Window controls
    $('wcbtn-min').onclick = () => tauriInvoke('minimize_window').catch(() => window.__TAURI__?.window?.getCurrent()?.minimize());
    $('wcbtn-max').onclick = () => tauriInvoke('toggle_maximize').catch(() => window.__TAURI__?.window?.getCurrent()?.toggleMaximize());
    $('wcbtn-close').onclick = async () => {
        stopAutoAttach(); await detach();
        tauriInvoke('close_window').catch(() => window.__TAURI__?.window?.getCurrent()?.close().catch(() => window.close()));
    };

    // Execute — reads from Monaco, uses selected API backend
    $('btn-execute').onclick = async () => {
        if (!monacoEditor) { modal('Editor not ready.'); return; }

        const code = toOpiumwarePacket(monacoEditor.getValue());
        if (!code) { modal('Editor is empty.'); return; }

        const port = executeTarget === 'ALL'
            ? 'ALL'
            : (selectedPort || '8392');

        const btn = $('btn-execute');
        btn.disabled = true;
        const origHTML = btn.innerHTML;
        btn.innerHTML = origHTML.replace('Execute', 'Running...');

        try {
            let result;
            if (apiBackend === 'js') {
                result = await jsApiExecute(code, port);
            } else {
                result = await tauriInvoke('OpiumwareExecution', { code, port });
            }
            console.log('[Execute] result:', result);
            if (notifExecute) modal(result || 'Executed.');
            if (result && result.toLowerCase().includes('successfully')) {
                const m = result.match(/port[: ]+(\d+)/i);
                if (m && !connectedPort) setConnectedPort(m[1]);
            }
        } catch(e) {
            console.error('[Execute] error:', e);
            modal('Execute error: ' + String(e));
        } finally {
            btn.disabled = false;
            btn.innerHTML = origHTML;
        }
    };

    $('btn-clear').onclick = () => monacoEditor?.setValue('');
    $('btn-open').onclick  = async () => {
        // Try Tauri first, fall back to browser file picker
        if (window.__TAURI__) {
            try { const r = await tauriInvoke('open_file_dialog'); if(r) addTab(r.name, r.content); return; } catch(_) {}
        }
        // Browser fallback
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.lua,.txt,*';
        input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;
            const text = await file.text();
            addTab(file.name, text);
        };
        input.click();
    };
    $('btn-save').onclick  = async () => {
        const tab = tabs.find(t=>t.id===activeTabId); if(!tab) return;
        const content = monacoEditor?.getValue() || '';
        // Try Tauri first, fall back to browser download
        if (window.__TAURI__) {
            try { await tauriInvoke('save_file_dialog', { content, suggested_name: tab.name }); return; } catch(_) {}
        }
        // Browser fallback — triggers a download
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = tab.name.endsWith('.lua') || tab.name.endsWith('.txt') ? tab.name : tab.name + '.lua';
        a.click();
        URL.revokeObjectURL(url);
    };
    $('add-tab-btn').onclick = () => addTab();

    // Search input — triggers Monaco find widget
    $('tab-bar-search-input').addEventListener('input', e => {
        if (!monacoEditor) return;
        const q = e.target.value;
        if (q) {
            monacoEditor.trigger('search', 'actions.find', null);
            monacoEditor.getModel()?.findMatches(q, false, false, false, null, false);
            // Use Monaco's find controller
            const fc = monacoEditor.getContribution('editor.contrib.findController');
            if (fc) { fc.start({ searchString: q, replaceString: '', isRegex: false, matchCase: false, matchWholeWord: false }); }
        } else {
            monacoEditor.getAction('closeReferenceSearch')?.run();
            monacoEditor.focus();
        }
    });
    $('tab-bar-search-input').addEventListener('keydown', e => {
        if (e.key === 'Escape') { e.target.value = ''; monacoEditor?.focus(); }
        if (e.key === 'Enter') {
            const fc = monacoEditor?.getContribution('editor.contrib.findController');
            if (fc) e.shiftKey ? fc.moveToPrevMatch() : fc.moveToNextMatch();
        }
    });

    renderMainDdPorts();
}

// ══════════════════════════════
// MONACO BOOTSTRAP
// ══════════════════════════════
require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs' } });
require(['vs/editor/editor.main'], () => {
    monacoEditor = monaco.editor.create($('monaco-container'), {
        value: '', language: 'lua', theme: 'vs-dark',
        automaticLayout: true, fontSize: 12,
        minimap: { enabled: false }, lineNumbers: 'on',
        scrollbar: { verticalScrollbarSize: 8, horizontalScrollbarSize: 8, useShadows: false, vertical: 'auto', horizontal: 'auto' },
        lineNumbersMinChars: 3, padding: { top: 8 }
    });

    init();
    addTab(null, initialContent);

    monacoEditor.onDidChangeModelContent(() => {
        const tab = tabs.find(t => t.id === activeTabId);
        if (tab) tab.content = monacoEditor.getValue();
    });

    // Sync toggle states with actual editor options
    $('tog-minimap').checked = monacoEditor.getOption(monaco.editor.EditorOption.minimap).enabled;
    const lnOpt = monacoEditor.getOption(monaco.editor.EditorOption.lineNumbers);
    $('tog-linenums').checked = lnOpt?.renderType !== 0;
});
</script>
</body>
</html>
